version: v1.0
name: libnano pipeline

agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu2004

blocks:
  - name: Ubuntu 20.04
    task:
      prologue:
        commands:
          - checkout
          - bash scripts/setup_ubuntu2004.sh --default
      jobs:
        - name: format
          commands:
            - bash scripts/setup_ubuntu2004.sh --llvm 13
            - bash scripts/build.sh --clang-suffix -13 --clang-format
        - name: debug (gcc)
          commands:
            - CXX=g++ bash scripts/build.sh -DCMAKE_BUILD_TYPE=Debug --config --build --test
              --install --build-example
        - name: release (gcc)
          commands:
            - CXX=g++ bash scripts/build.sh -DCMAKE_BUILD_TYPE=Release --config --build --test
              --install --build-example
        - name: debug (clang)
          commands:
            - CXX=clang++ bash scripts/build.sh -DCMAKE_BUILD_TYPE=Debug --libcpp --config --build --test
              --install --build-example
        - name: ASAN (clang)
          commands:
            - CXX=clang++ bash scripts/build.sh -DCMAKE_BUILD_TYPE=Debug --asan --config --build --test
        - name: LSAN (clang)
          commands:
            - CXX=clang++ bash scripts/build.sh -DCMAKE_BUILD_TYPE=Debug --lsan --config --build --test
        - name: USAN (clang)
          commands:
            - CXX=clang++ bash scripts/build.sh -DCMAKE_BUILD_TYPE=Debug --usan --config --build --test
        - name: TSAN (clang)
          commands:
            - CXX=clang++ bash scripts/build.sh -DCMAKE_BUILD_TYPE=Debug --tsan --config --build --test
        - name: clang-tidy (clang, misc, cert, hicpp, bugprone)
          commands:
            - bash scripts/setup_ubuntu2004.sh --llvm 13
            - CXX=clang++-13 bash scripts/build.sh --clang-suffix -13 --config --build
              --clang-tidy-misc
              --clang-tidy-cert
              --clang-tidy-hicpp
              --clang-tidy-bugprone
        - name: clang-tidy (clang, modernize, performance, portability, readability)
          commands:
            - bash scripts/setup_ubuntu2004.sh --llvm 13
            - CXX=clang++-13 bash scripts/build.sh --clang-suffix -13 --config --build
              --clang-tidy-modernize
              --clang-tidy-performance
              --clang-tidy-portability
              --clang-tidy-readability
        - name: clang-tidy (clang, clang_analyzer, cppcoreguidelines)
          commands:
            - bash scripts/setup_ubuntu2004.sh --llvm 13
            - CXX=clang++-13 bash scripts/build.sh --clang-suffix -13 --config --build
              --clang-tidy-clang-analyzer
              --clang-tidy-cppcoreguidelines
        - name: cppcheck
          commands:
            - CXX=g++ bash scripts/build.sh --config --cppcheck
        - name: memcheck (gcc)
          commands:
            - CXX=g++ bash scripts/build.sh -DCMAKE_BUILD_TYPE=RelWithDebInfo --config --build --memcheck
        - name: code quality (clang, libcpp, llvm-cov, sonar scanner)
          commands:
            - bash scripts/setup_ubuntu2004.sh --llvm 13
            - CXX=clang++-13 bash scripts/build.sh --suffix llvm-lcov -DCMAKE_BUILD_TYPE=RelWithDebInfo
              --llvm-coverage --libcpp -DNANO_ENABLE_LLVM_COV=ON ${cmake_options} --config --build --test --llvm-cov
              --sonar
    dependencies: []
