version: v1.0
name: libnano pipeline
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu2004
blocks:
  - name: Ubuntu 20.04
    task:
      prologue:
        commands:
          - checkout
          - bash scripts/setup_ubuntu2004.sh --default
      jobs:
        - name: debug (gcc)
          commands:
            - CXX=g++ bash scripts/build.sh --build-type Debug --config --build --test --install --build-example
        - name: release (gcc)
          commands:
            - CXX=g++ bash scripts/build.sh --build-type Release --config --build --test --install --build-example
        - name: debug (clang)
          commands:
            - CXX=clang++ bash scripts/build.sh --build-type Debug --libcpp --config --build --test --install --build-example
        - name: ASAN (gcc)
          commands:
            - CXX=g++ bash scripts/build.sh --build-type Debug --asan --config --build --test
        - name: LSAN (gcc)
          commands:
            - CXX=g++ bash scripts/build.sh --build-type Debug --lsan --config --build --test
        - name: USAN (gcc)
          commands:
            - CXX=g++ bash scripts/build.sh --build-type Debug --usan --config --build --test
        - name: TSAN (gcc)
          commands:
            - CXX=g++ bash scripts/build.sh --build-type Debug --tsan --config --build --test
        - name: clang-tidy (clang)
          commands:
            - CXX=clang++ bash scripts/build.sh --config --build --clang-tidy-all
        - name: cppcheck
          commands:
            - CXX=g++ bash scripts/build.sh --config --cppcheck
        - name: memcheck (gcc)
          commands:
            - CXX=g++ bash scripts/build.sh --build-type RelWithDebInfo --config --build --memcheck
        - name: codecov (gcc)
          commands:
            - sudo -H pip install --upgrade pip
            - sudo -H pip install coverage
            - CXX=g++ GCOV=gcov bash scripts/build.sh --build-type RelWithDebInfo --coverage --config --build --test --codecov
    dependencies: []
